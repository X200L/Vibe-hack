<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Adventure Game</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #000;
      font-family: 'Courier New', monospace;
      color: white;
      touch-action: none;
      overflow: hidden;
    }

    #game-container {
      position: relative;
      width: 640px;
      max-width: 100%;
      height: 480px;
      border: 4px solid #333;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
    }

    canvas {
      display: block;
      background-color: #0a0a0a;
    }

    #start-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 10;
    }

    #start-button {
      padding: 15px 40px;
      font-size: 24px;
      background-color: #0f0;
      color: black;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
    }

    #score-display {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 18px;
      color: white;
      z-index: 5;
    }

    .d-pad {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 5px;
      width: 120px;
      height: 120px;
      opacity: 0.7;
      z-index: 5;
    }

    .d-pad button {
      background-color: rgba(255, 255, 255, 0.3);
      border: 1px solid white;
      color: white;
      font-size: 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .d-pad button:active {
      background-color: rgba(255, 255, 255, 0.6);
    }

    .up { grid-column: 2; grid-row: 1; }
    .down { grid-column: 2; grid-row: 3; }
    .left { grid-column: 1; grid-row: 2; }
    .right { grid-column: 3; grid-row: 2; }

    #win-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 100, 0, 0.9);
      z-index: 10;
      color: gold;
      font-size: 32px;
      font-weight: bold;
    }

    #win-button {
      margin-top: 20px;
      padding: 10px 30px;
      font-size: 20px;
      background-color: gold;
      color: black;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game-canvas" width="640" height="480"></canvas>

    <!-- –°—á—ë—Ç -->
    <div id="score-display">–û—á–∫–∏: 0 | –ö–ª—é—á: ‚ùå | –°–æ–∫—Ä–æ–≤–∏—â–µ: ‚ùå</div>

    <!-- –≠–∫—Ä–∞–Ω —Å—Ç–∞—Ä—Ç–∞ -->
    <div id="start-screen">
      <h1 style="color:#0f0;">ADVENTURE</h1>
      <p>–ù–∞–π–¥–∏ üîë, –∑–∞–±–µ—Ä–∏ üèÜ –∏ –≤–µ—Ä–Ω–∏—Å—å –¥–æ–º–æ–π!</p>
      <button id="start-button">üéÆ START</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø–æ–±–µ–¥—ã -->
    <div id="win-screen">
      –ü–û–ë–ï–î–ê!<br>–û—á–∫–∏: <span id="final-score">0</span>
      <button id="win-button">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>

    <!-- –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π D-Pad -->
    <div class="d-pad">
      <button class="d-pad up">‚¨ÜÔ∏è</button>
      <button class="d-pad down">‚¨áÔ∏è</button>
      <button class="d-pad left">‚¨ÖÔ∏è</button>
      <button class="d-pad right">‚û°Ô∏è</button>
    </div>
  </div>

  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width;
    const H = canvas.height;

    // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let gameActive = false;
    let score = 0;
    let hasKey = false;
    let hasTreasure = false;
    let playerX = 60, playerY = 60;
    const SIZE = 20;
    const SPEED = 3;

    // –í—Ä–∞–≥–∏
    const enemies = [
      { x: 200, y: 150, dx: 1, dy: 0, route: [{x:200,y:150}, {x:400,y:150}] },
      { x: 400, y: 300, dx: 0, dy: -1, route: [{x:400,y:300}, {x:400,y:100}] }
    ];

    // –õ–∞–±–∏—Ä–∏–Ω—Ç (—Å—Ç–µ–Ω—ã –∫–∞–∫ [x, y, w, h])
    const walls = [
      [100, 100, 200, 20],
      [300, 100, 20, 150],
      [100, 230, 220, 20],
      [400, 300, 100, 20],
      [500, 200, 20, 120]
    ];

    // –û–±—ä–µ–∫—Ç—ã
    const key = { x: 500, y: 100, collected: false };
    const treasure = { x: 550, y: 400, collected: false };

    // –ó–≤—É–∫–∏ (–ø—Ä–æ—Å—Ç—ã–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã)
    function playSound(freq, duration = 0.1) {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
      oscillator.type = "square";
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      oscillator.start();
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
      oscillator.stop(audioContext.currentTime + duration);
    }

    // –í–≤–æ–¥
    const keys = {};
    window.addEventListener('keydown', e => {
      keys[e.key.toLowerCase()] = true;
    });
    window.addEventListener('keyup', e => {
      keys[e.key.toLowerCase()] = false;
    });

    // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    const dPadButtons = document.querySelectorAll('.d-pad button');
    dPadButtons.forEach(btn => {
      btn.addEventListener('touchstart', () => {
        btn.classList.add('active');
        const dir = btn.classList[1];
        keys[dir] = true;
      });
      btn.addEventListener('touchend', () => {
        btn.classList.remove('active');
        const dir = btn.classList[1];
        keys[dir] = false;
      });
    });

    // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
    function movePlayer() {
      let dx = 0, dy = 0;

      if (keys['w'] || keys['arrowup'] || keys['up']) dy -= SPEED;
      if (keys['s'] || keys['arrowdown'] || keys['down']) dy += SPEED;
      if (keys['a'] || keys['arrowleft'] || keys['left']) dx -= SPEED;
      if (keys['d'] || keys['arrowright'] || keys['right']) dx += SPEED;

      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
      if (dx !== 0 && dy !== 0) {
        dx *= 0.7;
        dy *= 0.7;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π
      if (!checkCollision(playerX + dx, playerY)) playerX += dx;
      if (!checkCollision(playerX, playerY + dy)) playerY += dy;

      // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü
      playerX = Math.max(0, Math.min(W - SIZE, playerX));
      playerY = Math.max(0, Math.min(H - SIZE, playerY));
    }

    function checkCollision(x, y) {
      for (const wall of walls) {
        if (
          x < wall[0] + wall[2] &&
          x + SIZE > wall[0] &&
          y < wall[1] + wall[3] &&
          y + SIZE > wall[1]
        ) return true;
      }
      return false;
    }

    // –õ–æ–≥–∏–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
    function collectItems() {
      if (!key.collected && !hasKey && dist(playerX, playerY, key.x, key.y) < SIZE) {
        key.collected = true;
        hasKey = true;
        score += 10;
        playSound(523); // C5
        updateScore();
      }

      if (!treasure.collected && hasKey && !hasTreasure && dist(playerX, playerY, treasure.x, treasure.y) < SIZE) {
        treasure.collected = true;
        hasTreasure = true;
        score += 50;
        playSound(659); // E5
        updateScore();
      }

      // –ü–æ–±–µ–¥–∞: –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Ç–æ—á–∫—É —Å —Å–æ–∫—Ä–æ–≤–∏—â–µ–º
      if (hasTreasure && dist(playerX, playerY, 60, 60) < SIZE) {
        endGame(true);
      }
    }

    function dist(x1, y1, x2, y2) {
      return Math.hypot(x1 - x2, y1 - y2);
    }

    // –î–≤–∏–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
    function moveEnemies() {
      enemies.forEach(enemy => {
        enemy.x += enemy.dx;
        enemy.y += enemy.dy;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–∞–º–∏ –∏–ª–∏ –≤—ã—Ö–æ–¥ –∑–∞ –º–∞—Ä—à—Ä—É—Ç
        let hitWall = false;
        for (const wall of walls) {
          if (
            enemy.x < wall[0] + wall[2] &&
            enemy.x + SIZE > wall[0] &&
            enemy.y < wall[1] + wall[3] &&
            enemy.y + SIZE > wall[1]
          ) {
            hitWall = true;
            break;
          }
        }

        // –ü—Ä–æ—Å—Ç–æ–µ –ø–∞—Ç—Ä—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–≤—É–º —Ç–æ—á–∫–∞–º
        const target = enemy.route[1];
        const from = enemy.route[0];
        if (Math.abs(enemy.x - target.x) < 5 && Math.abs(enemy.y - target.y) < 5) {
          [enemy.dx, enemy.dy] = [-enemy.dx, -enemy.dy]; // —Ä–∞–∑–≤–æ—Ä–æ—Ç
        } else if (hitWall) {
          [enemy.dx, enemy.dy] = [-enemy.dx, -enemy.dy];
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
        if (dist(playerX, playerY, enemy.x, enemy.y) < SIZE) {
          playSound(200, 0.3);
          alert("–¢–µ–±—è –ø–æ–π–º–∞–ª–∏! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.");
          endGame(false);
        }
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç–∞
    function updateScore() {
      document.getElementById('score-display').textContent = 
        `–û—á–∫–∏: ${score} | –ö–ª—é—á: ${hasKey ? '‚úÖ' : '‚ùå'} | –°–æ–∫—Ä–æ–≤–∏—â–µ: ${hasTreasure ? '‚úÖ' : '‚ùå'}`;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    function draw() {
      ctx.clearRect(0, 0, W, H);

      // –§–æ–Ω
      ctx.fillStyle = '#0a0a0a';
      ctx.fillRect(0, 0, W, H);

      // –°—Ç–µ–Ω—ã
      ctx.fillStyle = '#666';
      for (const wall of walls) {
        ctx.fillRect(wall[0], wall[1], wall[2], wall[3]);
      }

      // –ö–ª—é—á
      if (!key.collected) {
        ctx.fillStyle = 'gold';
        ctx.fillRect(key.x, key.y, SIZE, SIZE);
        ctx.strokeStyle = '#ffcc00';
        ctx.strokeRect(key.x, key.y, SIZE, SIZE);
      }

      // –°–æ–∫—Ä–æ–≤–∏—â–µ
      if (!treasure.collected) {
        ctx.fillStyle = 'yellow';
        ctx.beginPath();
        ctx.arc(treasure.x + SIZE/2, treasure.y + SIZE/2, SIZE/2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'orange';
        ctx.beginPath();
        ctx.arc(treasure.x + SIZE/2, treasure.y + SIZE/2, SIZE/4, 0, Math.PI * 2);
        ctx.fill();
      }

      // –ò–≥—Ä–æ–∫ (—Å –∏–º–ø—Ä–æ–≤–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π "–∞–Ω–∏–º–∞—Ü–∏–µ–π" –º–∏–≥–∞–Ω–∏—è)
      const pulse = Math.sin(Date.now() / 200) * 5;
      ctx.fillStyle = '#0f0';
      ctx.fillRect(playerX, playerY, SIZE + pulse, SIZE + pulse);
      ctx.strokeStyle = '#fff';
      ctx.strokeRect(playerX, playerY, SIZE, SIZE);

      // –ì–ª–∞–∑–∏–∫ (–ª–∏—Ü–æ)
      ctx.fillStyle = 'black';
      ctx.fillRect(playerX + 14, playerY + 8, 3, 3);

      // –í—Ä–∞–≥–∏
      enemies.forEach(enemy => {
        ctx.fillStyle = '#f00';
        ctx.beginPath();
        ctx.arc(enemy.x + SIZE/2, enemy.y + SIZE/2, SIZE/2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(enemy.x + SIZE/2, enemy.y + SIZE/2, SIZE/6, 0, Math.PI * 2);
        ctx.fill();
      });

      // –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞
      ctx.strokeStyle = '#0f0';
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(50, 50, 30, 30);
      ctx.setLineDash([]);
    }

    // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –∏–≥—Ä—ã
    function gameLoop() {
      if (!gameActive) return;
      movePlayer();
      collectItems();
      moveEnemies();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
    function startGame() {
      gameActive = true;
      score = 0;
      hasKey = false;
      hasTreasure = false;
      playerX = 60; playerY = 60;
      key.collected = false;
      treasure.collected = false;
      enemies.forEach((e, i) => {
        Object.assign(e, { x: e.route[0].x, y: e.route[0].y, dx: e.dx, dy: e.dy });
      });
      updateScore();
      document.getElementById('start-screen').style.display = 'none';
      document.getElementById('win-screen').style.display = 'none';
      gameLoop();
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
    function endGame(win) {
      gameActive = false;
      if (win) {
        document.getElementById('final-score').textContent = score;
        document.getElementById('win-screen').style.display = 'flex';
      } else {
        document.getElementById('start-screen').style.display = 'flex';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    document.getElementById('start-button').addEventListener('click', startGame);
    document.getElementById('win-button').addEventListener('click', startGame);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    draw();
  </script>
</body>
</html>
